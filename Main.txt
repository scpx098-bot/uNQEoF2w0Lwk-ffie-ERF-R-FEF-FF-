--[[
  DOOMSENSE v2 for outcome memories V0.2
        by r3cup/doomsenseteam
]]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local Workspace = game:GetService("Workspace")
local CoreGui = game:GetService("CoreGui")
local Lighting = game:GetService("Lighting")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")
local SoundService = game:GetService("SoundService")
local LocalPlayer = Players.LocalPlayer
local Camera = Workspace.CurrentCamera
local IsScriptActive = true
local Connections = {}

-- ============================================================================
-- MOBILE CONTROL MODULE
-- ============================================================================
local MobileControl = {}
MobileControl.Buttons = {}
MobileControl.IsMobile = false
MobileControl.EditMode = false


-- Assets
local MOB_ICONS = {
    Menu    = "rbxassetid://7539983773",
    Fly     = "rbxassetid://13288142767",
    Speed   = "rbxassetid://6684648436",
    Taunt   = "rbxassetid://12099513379",
    ART     = "rbxassetid://136991531643800",
    EditOff = "rbxassetid://4772171909",
    EditOn  = "rbxassetid://9735358798"
}

-- Helper: Darken Color by percentage
local function Darken(color, amount)
    local h, s, v = color:ToHSV()
    return Color3.fromHSV(h, s, math.clamp(v * (1 - amount), 0, 1))
end

-- Device Check
local function CheckDevice()
    if UserInputService.TouchEnabled and not UserInputService.MouseEnabled then
        return true
    end
    return false
end
MobileControl.IsMobile = CheckDevice()

-- Main Button Creator
function MobileControl:CreateButton(id, icon, defaultPos, callback)
    if self.Buttons[id] and self.Buttons[id].Frame then
        self.Buttons[id].Frame:Destroy()
    end

    local ScreenGui = CoreGui:FindFirstChild("Doomsense_Mobile")
    if not ScreenGui then
        ScreenGui = Instance.new("ScreenGui")
        ScreenGui.Name = "Doomsense_Mobile"
        ScreenGui.Parent = CoreGui
        ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    end

    local pos = defaultPos
    if self.Buttons[id] and self.Buttons[id].SavedPos then
        pos = self.Buttons[id].SavedPos
    end

    local Frame = Instance.new("Frame")
    Frame.Name = id
    Frame.Size = UDim2.new(0, 50, 0, 50)
    Frame.Position = pos
    Frame.BackgroundTransparency = 1
    Frame.Visible = (self.IsMobile)
    Frame.Parent = ScreenGui

    local Rotator = Instance.new("Frame")
    Rotator.Name = "Rotator"
    Rotator.Size = UDim2.new(1, 0, 1, 0)
    Rotator.AnchorPoint = Vector2.new(0.5, 0.5)
    Rotator.Position = UDim2.new(0.5, 0, 0.5, 0)
    Rotator.BorderSizePixel = 0
    Rotator.Parent = Frame
    
    local Stroke = Instance.new("UIStroke")
    Stroke.Thickness = 2
    Stroke.Parent = Rotator

    local IconImg = Instance.new("ImageLabel")
    IconImg.Size = UDim2.new(0.6, 0, 0.6, 0)
    IconImg.AnchorPoint = Vector2.new(0.5, 0.5)
    IconImg.Position = UDim2.new(0.5, 0, 0.5, 0)
    IconImg.BackgroundTransparency = 1
    IconImg.Image = icon
    IconImg.ZIndex = 5
    IconImg.Parent = Frame

    local Label = Instance.new("TextLabel")
    Label.Size = UDim2.new(1.4, 0, 0.3, 0)
    Label.Position = UDim2.new(-0.2, 0, 1.1, 0)
    Label.BackgroundTransparency = 1
    Label.Text = id
    Label.Font = Enum.Font.Cartoon
    Label.TextSize = 14
    Label.TextStrokeTransparency = 0
    Label.Parent = Frame

    local ClickHitbox = Instance.new("TextButton")
    ClickHitbox.Size = UDim2.new(1, 0, 1, 0)
    ClickHitbox.BackgroundTransparency = 1
    ClickHitbox.Text = ""
    ClickHitbox.ZIndex = 10
    ClickHitbox.Parent = Frame

    local DragHitbox = Instance.new("TextButton")
    DragHitbox.Size = UDim2.new(1.2, 0, 1.2, 0)
    DragHitbox.Position = UDim2.new(-0.1, 0, -0.1, 0)
    DragHitbox.BackgroundColor3 = Color3.fromRGB(255, 255, 0)
    DragHitbox.BackgroundTransparency = 0.7
    DragHitbox.Text = "DRAG"
    DragHitbox.Visible = false
    DragHitbox.ZIndex = 20
    DragHitbox.Parent = Frame

    local isActive = false
    if self.Buttons[id] then isActive = self.Buttons[id].State end

    local function UpdateVisuals()
        local Theme = _G.DoomsenseTheme or { 
            Background = Color3.fromRGB(43,43,43), 
            Text = Color3.fromRGB(224,224,224), 
            Accent = Color3.fromHex("4FD1C5"), 
            Stroke = Color3.fromRGB(30,30,30)
        }
        
        Label.TextColor3 = Theme.Text
        Label.TextStrokeColor3 = Theme.Background
        IconImg.ImageColor3 = Theme.Text

        local targetRot = isActive and 45 or 0
        local targetColor = isActive and Darken(Theme.Accent, 0.5) or Theme.Background
        local targetStroke = isActive and Theme.Accent or Theme.Stroke
        local targetTransp = isActive and 0.2 or 0.1

        TweenService:Create(Rotator, TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
            Rotation = targetRot,
            BackgroundColor3 = targetColor,
            BackgroundTransparency = targetTransp
        }):Play()
        
        Stroke.Color = targetStroke
    end

    ClickHitbox.MouseButton1Click:Connect(function()
        if not self.EditMode then
            isActive = not isActive
            UpdateVisuals()
            if callback then callback(isActive) end
            if self.Buttons[id] then self.Buttons[id].State = isActive end
        end
    end)

    local dragging, dragInput, dragStart, startPos
    DragHitbox.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = Frame.Position
        end
    end)
    
    DragHitbox.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - dragStart
            Frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
            if self.Buttons[id] then self.Buttons[id].SavedPos = Frame.Position end
        end
    end)
    
    DragHitbox.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
        end
    end)

    self.Buttons[id] = {
        Frame = Frame, Rotator = Rotator, ClickHitbox = ClickHitbox, DragHitbox = DragHitbox,
        Update = UpdateVisuals, State = isActive, SavedPos = Frame.Position
    }
    
    UpdateVisuals()
end

function MobileControl:UpdateAllThemes()
    for _, btn in pairs(self.Buttons) do
        if btn.Update then btn.Update() end
    end
end

function MobileControl:ToggleEditMode(state)
    self.EditMode = state
    for _, btn in pairs(self.Buttons) do
        if btn.Frame then
            btn.ClickHitbox.Visible = not state
            btn.DragHitbox.Visible = state
        end
    end
end

function MobileControl:RefreshVisibility()
    local show = (self.IsMobile)
    local ScreenGui = CoreGui:FindFirstChild("Doomsense_Mobile")
    if ScreenGui then ScreenGui.Enabled = show end
end

-- ============================================================================
-- LMS SYSTEM: LOGIC & DATA
-- ============================================================================
local LMS_FOLDER = "Doomsense.custom.lms"

local executor = (identifyexecutor or getexecutorname or function() return "Unknown" end)()
local isDelta = string.find(string.lower(executor), "delta")
local isXeno = string.find(string.lower(executor), "xeno")

if not (isDelta or isXeno) then
    warn("DOOMSENSE: Unsupported Executor detected (" .. executor .. ")")
    pcall(function()
        game:GetService("StarterGui"):SetCore("SendNotification", {
            Title = "DOOMSENSE WARNING",
            Text = "Download Xeno or Delta for best experience",
            Duration = 5,
            Button1 = "OK"
        })
    end)
end

local LMS_State = { 
    Enabled = false,
    SelectedTrack = "AW SHUCKS",
    Active = false, 
    Volume = 1.2,
    IsSequenceRunning = false
}

local LMS_Library = {
    ["AW SHUCKS"] = "https://files.catbox.moe/s46doh.ogg",
    ["NO MORE GAME"] = "https://files.catbox.moe/1c4g8w.ogg",
    ["New World"] = "https://files.catbox.moe/k29d2o.ogg",
    ["MODERN SONIC"] = "https://files.catbox.moe/t698xi.ogg",
    ["HIS CHALLENGE"] = "https://files.catbox.moe/h0ok1e.ogg",
    ["EGGSOLO(remix)"] = "https://files.catbox.moe/3u22j4.ogg",
    ["dead or live v0.1"] = "https://files.catbox.moe/ncxotb.ogg",
    ["Beyond The Painting"] = "https://files.catbox.moe/j27pbt.ogg",
    ["BadTime"] = "https://files.catbox.moe/5tm79x.ogg"
}

local LMS_Originals = {
    ["AmySolo"] = "rbxassetid://123535390530506",
    ["BlazeSolo"] = "rbxassetid://132006407031162",
    ["CreamSolo"] = "rbxassetid://101771084079612",
    ["Eggmansolo"] = "rbxassetid://86981182369115",
    ["KnucklesSolo"] = "rbxassetid://100259476227315",
    ["MetalSonicSolo"] = "rbxassetid://82965945880276",
    ["SilverSolo"] = "rbxassetid://77138683500819",
    ["SonicSolo"] = "rbxassetid://136212496176401",
    ["TailsSolo"] = "rbxassetid://101018907191326"
}

local function GetGameState()
    if Workspace:FindFirstChild("GameProperties") and Workspace.GameProperties:FindFirstChild("State") then
        return Workspace.GameProperties.State.Value
    end
    return "UNKNOWN"
end

local function GetSoloFolder()
    return ReplicatedStorage:FindFirstChild("ClientAssets") 
        and ReplicatedStorage.ClientAssets:FindFirstChild("Sounds")
        and ReplicatedStorage.ClientAssets.Sounds:FindFirstChild("mus")
        and ReplicatedStorage.ClientAssets.Sounds.mus:FindFirstChild("Game")
        and ReplicatedStorage.ClientAssets.Sounds.mus.Game:FindFirstChild("Round")
        and ReplicatedStorage.ClientAssets.Sounds.mus.Game.Round:FindFirstChild("SoloTheme")
end

local function IsEXE(model)
    if not model then return false end
    local charAttr = model:GetAttribute("Character")
    local targetName = charAttr or model.Name
    local killers = {"TailsDoll", "Kolossos", "2011x", "Fleetway", "Tripwire", "Furnace", "Lord X", "EXE"}
    for _, k in pairs(killers) do
        if string.find(string.lower(tostring(targetName)), string.lower(k)) then return true end
    end
    return false
end

local function GetCustomAsset(path)
    if getcustomasset then return getcustomasset(path) end
    if getsynasset then return getsynasset(path) end
    return "" 
end

local function ApplyLMS(mode)
    local folder = GetSoloFolder()
    if not folder then return end

    if mode == "Default" then
        for name, id in pairs(LMS_Originals) do
            local s = folder:FindFirstChild(name)
            if s then 
                s.SoundId = id
                s.Volume = 1.2 
            end
        end
    else
        local trackName = LMS_State.SelectedTrack
        local path = LMS_FOLDER .. "/" .. trackName .. ".ogg"
        
        if isfile(path) then
            local customId = GetCustomAsset(path)
            for name, _ in pairs(LMS_Originals) do
                local s = folder:FindFirstChild(name)
                if s then 
                    s.SoundId = customId 
                    s.Volume = LMS_State.Volume
                end
            end
        end
    end
end

-- Download
task.spawn(function()
    if not isfolder(LMS_FOLDER) then 
        makefolder(LMS_FOLDER) 
    end
    
    for name, url in pairs(LMS_Library) do
        local path = LMS_FOLDER .. "/" .. name .. ".ogg"
        if not isfile(path) then
            pcall(function()
                local content = game:HttpGet(url)
                if content and #content > 0 then
                    writefile(path, content)
                    print("DOOMSENSE: Downloaded " .. name)
                end
            end)
            if isDelta then task.wait(0.1) end
        end
    end
end)

task.spawn(function()
    while true do
        if not IsScriptActive then break end
        task.wait(0.5)
        
        if LMS_State.Enabled and LocalPlayer.Character then
            local currentState = GetGameState()
            local survivors = {}
            local pFolder = Workspace:FindFirstChild("Players")
            local amIAlive = false
            
            if pFolder then
                for _, p in pairs(pFolder:GetChildren()) do
                    if not IsEXE(p) and p.Name ~= "Default" then 
                        table.insert(survivors, p)
                        if p.Name == LocalPlayer.Name then amIAlive = true end
                    end
                end
            end
            
            -- ON Only for ING or 80s
            local isGameRunning = (currentState == "ING" or currentState == "80s")
            
            if isGameRunning and #survivors == 1 and amIAlive and not LMS_State.Active and not LMS_State.IsSequenceRunning then
                LMS_State.Active = true
                ApplyLMS("Custom")
            end

            -- RE (Round End)
            if LMS_State.Active and currentState == "RE" and not LMS_State.IsSequenceRunning then
                LMS_State.IsSequenceRunning = true
                LMS_State.Active = false
                
                local folder = GetSoloFolder()
                local playingSound = nil
                
                if folder then
                    for name, _ in pairs(LMS_Originals) do
                        local s = folder:FindFirstChild(name)
                        if s and s.Playing then 
                            playingSound = s 
                            break 
                        end
                    end
                end

                if playingSound then
                    task.spawn(function()
                        playingSound.IsMutedForCapture = true
                        task.wait(20)
                        playingSound.Playing = false
                        playingSound.TimePosition = 0
                        playingSound.IsMutedForCapture = false
                        ApplyLMS("Default")
                        LMS_State.IsSequenceRunning = false
                    end)
                else
                    ApplyLMS("Default")
                    LMS_State.IsSequenceRunning = false
                end
            end
            
            -- RESET
            local isLobby = (currentState == "INT" or currentState == "SEC" or currentState == "MS")
            
            if (isLobby or (isGameRunning and not amIAlive) or (isGameRunning and #survivors > 1)) and LMS_State.Active then
                LMS_State.Active = false
                LMS_State.IsSequenceRunning = false
                ApplyLMS("Default")
            end
        end
    end
end)

-- ============================================================================
-- GAME LOGIC: CHEATS & DATA
-- ============================================================================

local AppConfig = {
    FlySpeed = 60, WalkSpeed = 45, NoCDJump = false,
    AutoRing = false, ESP = false, Glow = false, PadESP = false,
    SelectedChar = "2011X", Noclip = false, Fly = false
}

local State = { IsFlying = false, IsSpeeding = false, SelectedPlayer = nil }

local AnimDB = {
    ["Sonic"] = {{Name = "Relaxing", Id = "104062552147146"}, {Name = "Waiting", Id = "132709141019647"}, {Name = "RingWalk", Id = "123377580352862"}, {Name = "TickTock", Id = "93800356049298"}, {Name = "Baby Dance", Id = "79203936383675"}, {Name = "Shonic", Id = "124702409687881"}, {Name = "Medicine", Id = "86397585701161"}, {Name = "Paced", Id = "117900173410005"}, {Name = "Impatience", Id = "87992356942409"}, {Name = "PBJ", Id = "113910526539334"}, {Name = "Pipebomb", Id = "130034868708651"}, {Name = "Diaries", Id = "92897830029002"}},
    ["Tails"] = {{Name = "Helicopter", Id = "89515158858178"}, {Name = "Sit", Id = "132926716277265"}, {Name = "Rat Dance", Id = "73313302543888"}, {Name = "Cory", Id = "118810363050448"}, {Name = "Pipebomb", Id = "137946742808216"}, {Name = "Who", Id = "84541229170186"}, {Name = "Horse", Id = "93036777474390"}, {Name = "GoodbyeForever", Id = "96963375850749"}},
    ["Knuckles"] = {{Name = "ChillOut", Id = "96036373262427"}, {Name = "Stephanie", Id = "140682945610579"}, {Name = "Aura", Id = "97453636614232"}, {Name = "Sitting", Id = "79209172925447"}, {Name = "DoThatThing", Id = "78791270212133"}, {Name = "HitEveryBeat", Id = "80597715589852"}, {Name = "FallenKingdom", Id = "108656705089262"}},
    ["Amy"] = {{Name = "DanceOfJustice", Id = "97841662978305"}, {Name = "Smiley", Id = "83086430858295"}, {Name = "Surprised", Id = "95622465731556"}, {Name = "Headbang", Id = "113537674050921"}, {Name = "Doodle", Id = "107060462123341"}, {Name = "Static", Id = "91094123750588"}, {Name = "LoveNCavity", Id = "76749834700097"}, {Name = "Noodle", Id = "111017557755415"}, {Name = "Eek!", Id = "83310660894486"}},
    ["Cream"] = {{Name = "Overdrive", Id = "126157584199051"}, {Name = "CatSwing", Id = "119996423025347"}, {Name = "JevilHop", Id = "137069582420732"}, {Name = "Penguin", Id = "136126837988845"}, {Name = "Waving", Id = "101475077691415"}, {Name = "Griddy", Id = "88275250559180"}},
    ["Eggman"] = {{Name = "Egg Rolled", Id = "109633747241470"}, {Name = "Sturdy", Id = "123633884307468"}, {Name = "Boohoo", Id = "118361359360130"}, {Name = "MasterPlan", Id = "135726076356843"}, {Name = "WhyPost", Id = "75695304745148"}, {Name = "Eggly", Id = "125599236186100"}, {Name = "BirdWord", Id = "126886074967700"}, {Name = "Forklift", Id = "127435576488001"}},
    ["Silver"] = {{Name = "Levitate", Id = "127010236869854"}, {Name = "ReleaseGhouls", Id = "76998542362740"}},
    ["Metal Sonic"] = {{Name = "Egg Rolled 2", Id = "128123227077719"}, {Name = "Thinking", Id = "116585917682409"}, {Name = "FancyStyle", Id = "124654816579604"}, {Name = "Lonely", Id = "116357078780443"}, {Name = "ComeCloser", Id = "76249045959187"}},
    ["Blaze"] = {{Name = "ReleaseTheGhouls", Id = "104705063785739"}, {Name = "ChineseCat", Id = "129541820196808"}, {Name = "Skachacha", Id = "128435480269503"}},
    ["2011X"] = {{Name = "Laugh", Id = "73313302543888"}, {Name = "Maria Carey", Id = "92888638699962"}, {Name = "Hype", Id = "78545771079470"}, {Name = "Jersey Hog", Id = "127191399093079"}},
    ["Kolossos"] = {{Name = "Point", Id = "140180851930686"}, {Name = "MissMe", Id = "81730809348394"}, {Name = "Metroman", Id = "107195453398060"}, {Name = "Laugh", Id = "102779996718354"}},
    ["TailsDoll"] = {{Name = "TripwireTime", Id = "112656139256072"}, {Name = "TripwireSit", Id = "92259033776440"}, {Name = "Imposter", Id = "100732265533480"}, {Name = "Caramel", Id = "81240310070946"}}
}

local NameToKey = { ["Tripwire"] = "TailsDoll" }
local OrderedCharacters = {"2011X", "Tripwire", "Kolossos", "Metal Sonic", "Knuckles", "Eggman", "Cream", "Silver", "Sonic", "Blaze", "Tails", "Amy"}

local BodyVel, BodyGyro, AnimTrack
local T_Fly, T_Speed, T_Ring

local function CleanPhysics()
    if BodyVel then BodyVel:Destroy() BodyVel = nil end
    if BodyGyro then BodyGyro:Destroy() BodyGyro = nil end
    local char = LocalPlayer.Character
    if char and char:FindFirstChild("HumanoidRootPart") then
        for _, v in pairs(char.HumanoidRootPart:GetChildren()) do
            if v.Name == "DoomVel" or v.Name == "DoomGyro" then v:Destroy() end
        end
        char.HumanoidRootPart.Velocity = Vector3.new(0,0,0)
        local hum = char:FindFirstChild("Humanoid")
        if hum then hum.PlatformStand = false end
        char:SetAttribute("State", "default")
    end
end

local function EnableFly()
    local char = LocalPlayer.Character
    if not char then return end
    local hum = char:FindFirstChild("Humanoid")
    local root = char:FindFirstChild("HumanoidRootPart")
    if not hum or not root then return end
    CleanPhysics()
    BodyVel = Instance.new("BodyVelocity", root)
    BodyVel.Name = "DoomVel"
    BodyVel.MaxForce = Vector3.new(9e9, 9e9, 9e9)
    BodyVel.Velocity = Vector3.new(0,0,0)
    BodyGyro = Instance.new("BodyGyro", root)
    BodyGyro.Name = "DoomGyro"
    BodyGyro.MaxTorque = Vector3.new(9e9, 9e9, 9e9)
    BodyGyro.P = 10000
    hum.PlatformStand = true
    char:SetAttribute("State", "Gliding")
end

-- ============================================================================
-- INTERNAL UI ENGINE
-- ============================================================================

local GUI = {}
GUI.Objects = {}

local CurrentThemes = {
    ["Default"] = {
        Background = Color3.fromRGB(43, 43, 43), Sidebar = Color3.fromRGB(43, 43, 43),
        Element = Color3.fromRGB(50, 50, 50), Text = Color3.fromRGB(224, 224, 224),
        TextDim = Color3.fromRGB(150, 150, 150), Accent = Color3.fromHex("4FD1C5"),
        VerticalScroll = Color3.fromRGB(200, 200, 200), Stroke = Color3.fromRGB(30, 30, 30)
    },
    ["Red"] = {
        Background = Color3.fromRGB(20, 20, 20), Sidebar = Color3.fromRGB(20, 20, 20),
        Element = Color3.fromRGB(35, 35, 35), Text = Color3.fromRGB(255, 255, 255),
        TextDim = Color3.fromRGB(180, 100, 100), Accent = Color3.fromRGB(255, 65, 65),
        VerticalScroll = Color3.fromRGB(100, 50, 50), Stroke = Color3.fromRGB(50, 20, 20)
    },
     ["Full Blue"] = {
        Background = Color3.fromRGB(15, 25, 35), Sidebar = Color3.fromRGB(15, 25, 35),
        Element = Color3.fromRGB(30, 45, 60), Text = Color3.fromRGB(200, 230, 255),
        TextDim = Color3.fromRGB(100, 150, 200), Accent = Color3.fromRGB(0, 160, 255),
        VerticalScroll = Color3.fromRGB(50, 100, 150), Stroke = Color3.fromRGB(20, 40, 60)
    },
    ["Green"] = {
        Background = Color3.fromRGB(17, 17, 17), Sidebar = Color3.fromRGB(12, 12, 12),
        Element = Color3.fromRGB(25, 25, 25), Text = Color3.fromRGB(255, 255, 255),
        TextDim = Color3.fromRGB(150, 150, 150), Accent = Color3.fromRGB(155, 205, 50),
        VerticalScroll = Color3.fromRGB(155, 205, 50), Stroke = Color3.fromRGB(0, 0, 0)
    },
    ["Gold"] = {
        Background = Color3.fromRGB(15, 15, 15), Sidebar = Color3.fromRGB(20, 20, 20),
        Element = Color3.fromRGB(10, 10, 10), Text = Color3.fromRGB(255, 255, 255),
        TextDim = Color3.fromRGB(180, 160, 100), Accent = Color3.fromRGB(255, 190, 0),
        VerticalScroll = Color3.fromRGB(255, 190, 0), Stroke = Color3.fromRGB(40, 35, 20)
    },
    ["Full Dark"] = {
        Background = Color3.fromRGB(10, 10, 10), Sidebar = Color3.fromRGB(5, 5, 5),
        Element = Color3.fromRGB(20, 20, 20), Text = Color3.fromRGB(255, 255, 255),
        TextDim = Color3.fromRGB(100, 100, 100), Accent = Color3.fromRGB(255, 255, 255),
        VerticalScroll = Color3.fromRGB(30, 30, 30), Stroke = Color3.fromRGB(0, 0, 0)
    },
    ["Full purple"] = {
        Background = Color3.fromRGB(18, 12, 28), Sidebar = Color3.fromRGB(14, 8, 22),
        Element = Color3.fromRGB(30, 22, 45), Text = Color3.fromRGB(255, 255, 255),
        TextDim = Color3.fromRGB(170, 150, 190), Accent = Color3.fromRGB(195, 35, 255),
        VerticalScroll = Color3.fromRGB(195, 35, 255), Stroke = Color3.fromRGB(60, 40, 90)
    }
}

local CurrentTheme = CurrentThemes["Default"]
_G.DoomsenseTheme = CurrentTheme -- Expose for Mobile Module
local SelectedThemeName = "Default"

function GUI:Create(class, props)
    local inst = Instance.new(class)
    for k, v in pairs(props) do if k ~= "Parent" then inst[k] = v end end
    if props.Parent then inst.Parent = props.Parent end
    table.insert(GUI.Objects, inst)
    return inst
end

function GUI:MakeDraggable(topbar, frame)
    local dragging, dragInput, dragStart, startPos
    topbar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position; startPos = frame.Position
            input.Changed:Connect(function() if input.UserInputState == Enum.UserInputState.End then dragging = false end end)
        end
    end)
    topbar.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then dragInput = input end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            TweenService:Create(frame, TweenInfo.new(0.05), {Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)}):Play()
        end
    end)
end

function GUI:InitWindow(title)
    if CoreGui:FindFirstChild("DoomsenseUI") then CoreGui.DoomsenseUI:Destroy() end
    
    local ScreenGui = self:Create("ScreenGui", {Name = "DoomsenseUI", Parent = CoreGui, ZIndexBehavior = Enum.ZIndexBehavior.Sibling})
    
    local Main = self:Create("Frame", {
        Name = "Main", Parent = ScreenGui, Size = UDim2.fromOffset(600, 420),
        Position = UDim2.fromScale(0.5, 0.5), AnchorPoint = Vector2.new(0.5, 0.5),
        BackgroundColor3 = CurrentTheme.Background, BackgroundTransparency = 0.05, BorderSizePixel = 0
    })

    -- [ИЗМЕНЕНИЕ: Синхронизация кнопки Menu с окном]
    -- Если окно открывается/закрывается (в т.ч. через Insert), обновляем мобильную кнопку
    Main:GetPropertyChangedSignal("Visible"):Connect(function()
        local isVisible = Main.Visible
        if MobileControl.Buttons["Menu"] then
            -- Синхронизируем состояние кнопки
            MobileControl.Buttons["Menu"].State = isVisible
            -- Обновляем визуал (цвет/поворот)
            MobileControl.Buttons["Menu"].Update()
        end
    end)

    local MouseFix = Instance.new("TextButton", Main)
    MouseFix.Size = UDim2.new(1, 0, 1, 0)
    MouseFix.BackgroundTransparency = 1
    MouseFix.Text = ""
    MouseFix.Modal = not (MobileControl.IsMobile)
    MouseFix.ZIndex = -1

    self:Create("UICorner", {CornerRadius = UDim.new(0, 8), Parent = Main})
    self:Create("UIStroke", {Color = Color3.new(0,0,0), Thickness = 1, Transparency = 0.6, Parent = Main})

    local TopBar = self:Create("Frame", {Name = "TopBar", Parent = Main, Size = UDim2.new(1, 0, 0, 35), BackgroundTransparency = 1})
    self:Create("TextLabel", {
        Parent = TopBar, Text = "  " .. title, Size = UDim2.new(0.5, 0, 1, 0),
        BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left,
        Font = Enum.Font.GothamMedium, TextSize = 14, TextColor3 = CurrentTheme.Text
    })
    self:MakeDraggable(TopBar, Main)
    
    -- Controls Container
    local Controls = self:Create("Frame", {Parent = TopBar, Size = UDim2.new(0, 90, 1, 0), Position = UDim2.new(1, -90, 0, 0), BackgroundTransparency = 1})
    
    -- EDIT BUTTON (Mobile)
    local EditBtn = self:Create("ImageButton", {
        Parent = Controls, 
        Size = UDim2.new(0, 20, 0, 20), 
        -- Позиция будет настроена ниже в зависимости от устройства
        Position = UDim2.new(0, 30, 0.5, -10),
        BackgroundTransparency = 1, 
        Image = MOB_ICONS.EditOff,
        ImageColor3 = CurrentTheme.TextDim,
        Visible = false -- По умолчанию скрыто, включим если Mobile
    })

    local CloseBtn = self:Create("TextButton", {
        Parent = Controls, Text = "X", Size = UDim2.new(0, 30, 1, 0), Position = UDim2.new(0, 60, 0, 0),
        BackgroundTransparency = 1, TextColor3 = CurrentTheme.TextDim, Font = Enum.Font.Gotham
    })
    
    -- [ИЗМЕНЕНИЕ 2: Логика отображения кнопок для Mobile vs PC]
    if MobileControl.IsMobile then
        -- Если с телефона: Скрываем X, ставим кнопку редактора на его место
        CloseBtn.Visible = false
        EditBtn.Visible = true
        EditBtn.Position = UDim2.new(0, 60, 0.5, -10) -- Сдвигаем вправо на место X
    else
        -- Если ПК: Показываем X, скрываем редактор
        CloseBtn.Visible = true
        EditBtn.Visible = false
    end

    -- Edit Button Logic
    EditBtn.MouseButton1Click:Connect(function()
        MobileControl.EditMode = not MobileControl.EditMode
        EditBtn.Image = MobileControl.EditMode and MOB_ICONS.EditOn or MOB_ICONS.EditOff
        EditBtn.ImageColor3 = MobileControl.EditMode and CurrentTheme.Accent or CurrentTheme.TextDim
        
        -- Если мы в режиме редактирования, само меню можно скрыть или оставить, 
        -- но X нам не нужен, так как мы на телефоне
        MobileControl:ToggleEditMode(MobileControl.EditMode)
    end)

    CloseBtn.MouseButton1Click:Connect(function() 
        Main.Visible = false
    end)

    local Sidebar = self:Create("Frame", {
        Parent = Main, Size = UDim2.new(0, 150, 1, -35), Position = UDim2.new(0, 0, 0, 35),
        BackgroundColor3 = CurrentTheme.Sidebar, BackgroundTransparency = 1, BorderSizePixel = 0
    })
    self:Create("UICorner", {CornerRadius = UDim.new(0, 8), Parent = Sidebar})
    local TabContainer = self:Create("ScrollingFrame", {
        Parent = Sidebar, Size = UDim2.new(1, 0, 1, -20), Position = UDim2.new(0,0,0,10),
        BackgroundTransparency = 1, ScrollBarThickness = 0, ScrollingEnabled = false
    })
    self:Create("UIListLayout", {Parent = TabContainer, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 5)})
    local ContentArea = self:Create("Frame", {
        Parent = Main, Size = UDim2.new(1, -160, 1, -45), Position = UDim2.new(0, 155, 0, 40),
        BackgroundTransparency = 1
    })
    
    -- Обработка клавиши Insert для ПК (Toggle)
    -- Мобильная кнопка сама обновится благодаря событию Main:GetPropertyChangedSignal("Visible")
    UserInputService.InputBegan:Connect(function(input, gpe)
        if not gpe and input.KeyCode == Enum.KeyCode.Insert then 
            Main.Visible = not Main.Visible 
        end
    end)
    
    return {Gui = ScreenGui, TabContainer = TabContainer, ContentArea = ContentArea, Tabs = {}, CurrentTab = nil}
end

function GUI:CreateTab(window, name, iconId)
    local TabBtn = self:Create("TextButton", {Parent = window.TabContainer, Size = UDim2.new(1, 0, 0, 35), BackgroundTransparency = 1, Text = ""})
    local Indicator = self:Create("Frame", {
        Parent = TabBtn, Size = UDim2.new(0, 3, 0.6, 0), Position = UDim2.new(0, 0, 0.2, 0),
        BackgroundColor3 = CurrentTheme.Accent, BackgroundTransparency = 1
    })
    local Label = self:Create("TextLabel", {
        Parent = TabBtn, Text = name, Size = UDim2.new(1, -25, 1, 0), Position = UDim2.new(0, 25, 0, 0),
        BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left,
        Font = Enum.Font.Gotham, TextSize = 13, TextColor3 = CurrentTheme.TextDim
    })
    if iconId then
        self:Create("ImageLabel", {
            Parent = TabBtn, Image = "rbxassetid://"..iconId, Size = UDim2.new(0, 16, 0, 16),
            Position = UDim2.new(0, 5, 0.5, -8), BackgroundTransparency = 1, ImageColor3 = CurrentTheme.TextDim
        })
    end
    local Page = self:Create("ScrollingFrame", {
        Parent = window.ContentArea, Size = UDim2.new(1, 0, 1, 0), BackgroundTransparency = 1, Visible = false, 
        ScrollBarThickness = 2, ScrollBarImageColor3 = CurrentTheme.VerticalScroll, ScrollBarImageTransparency = 0, BorderSizePixel = 0
    })
    self:Create("UIListLayout", {Parent = Page, SortOrder = Enum.SortOrder.LayoutOrder, Padding = UDim.new(0, 8)})
    self:Create("UIPadding", {Parent = Page, PaddingTop = UDim.new(0,5), PaddingLeft = UDim.new(0,5), PaddingRight = UDim.new(0,5)})
    TabBtn.MouseButton1Click:Connect(function()
        for _, t in pairs(window.Tabs) do
            t.Page.Visible = false; t.Indicator.BackgroundTransparency = 1
            TweenService:Create(t.Label, TweenInfo.new(0.2), {TextColor3 = CurrentTheme.TextDim}):Play()
        end
        Page.Visible = true; Indicator.BackgroundTransparency = 0
        TweenService:Create(Label, TweenInfo.new(0.2), {TextColor3 = CurrentTheme.Text}):Play()
    end)
    if #window.Tabs == 0 then
        Page.Visible = true; Indicator.BackgroundTransparency = 0; Label.TextColor3 = CurrentTheme.Text
    end
    local TabObj = {Page = Page, Indicator = Indicator, Label = Label}
    table.insert(window.Tabs, TabObj)

    function TabObj:Section(text)
        GUI:Create("TextLabel", {
            Parent = Page, Text = text, Size = UDim2.new(1, 0, 0, 25), BackgroundTransparency = 1, TextColor3 = CurrentTheme.Text,
            Font = Enum.Font.GothamBold, TextSize = 14, TextXAlignment = Enum.TextXAlignment.Left
        })
    end
    function TabObj:Button(text, callback)
        local Btn = GUI:Create("TextButton", {
            Parent = Page, Text = "", Size = UDim2.new(1, -5, 0, 35), BackgroundColor3 = CurrentTheme.Element, AutoButtonColor = false, BorderSizePixel = 0
        })
        GUI:Create("UICorner", {CornerRadius = UDim.new(0, 6), Parent = Btn})
        GUI:Create("TextLabel", {
            Parent = Btn, Text = text, Size = UDim2.new(1, -30, 1, 0), Position = UDim2.new(0, 10, 0, 0),
            BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left, TextColor3 = CurrentTheme.Text, Font = Enum.Font.GothamMedium, TextSize = 13
        })
        Btn.MouseButton1Click:Connect(function()
            TweenService:Create(Btn, TweenInfo.new(0.1), {BackgroundColor3 = CurrentTheme.Accent}):Play()
            task.wait(0.1)
            TweenService:Create(Btn, TweenInfo.new(0.3), {BackgroundColor3 = CurrentTheme.Element}):Play()
            if callback then callback() end
        end)
    end
    function TabObj:Toggle(text, default, callback)
        local Togl = GUI:Create("TextButton", {
            Parent = Page, Text = "", Size = UDim2.new(1, -5, 0, 35), BackgroundColor3 = CurrentTheme.Element, AutoButtonColor = false, BorderSizePixel = 0
        })
        GUI:Create("UICorner", {CornerRadius = UDim.new(0, 6), Parent = Togl})
        GUI:Create("TextLabel", {
            Parent = Togl, Text = text, Size = UDim2.new(1, -50, 1, 0), Position = UDim2.new(0, 10, 0, 0),
            BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left, TextColor3 = CurrentTheme.Text, Font = Enum.Font.GothamMedium, TextSize = 13
        })
        local SwitchBg = GUI:Create("Frame", {
            Parent = Togl, Size = UDim2.new(0, 36, 0, 18), Position = UDim2.new(1, -45, 0.5, -9), BackgroundColor3 = Color3.fromRGB(30,30,30)
        })
        GUI:Create("UICorner", {CornerRadius = UDim.new(1,0), Parent = SwitchBg})
        local Knob = GUI:Create("Frame", {
            Parent = SwitchBg, Size = UDim2.new(0, 14, 0, 14), Position = UDim2.new(0, 2, 0.5, -7), BackgroundColor3 = Color3.fromRGB(150,150,150)
        })
        GUI:Create("UICorner", {CornerRadius = UDim.new(1,0), Parent = Knob})
        local state = default or false
        local function Update()
            if state then
                TweenService:Create(SwitchBg, TweenInfo.new(0.2), {BackgroundColor3 = CurrentTheme.Accent}):Play()
                TweenService:Create(Knob, TweenInfo.new(0.2), {Position = UDim2.new(1, -16, 0.5, -7), BackgroundColor3 = Color3.new(1,1,1)}):Play()
            else
                TweenService:Create(SwitchBg, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(30,30,30)}):Play()
                TweenService:Create(Knob, TweenInfo.new(0.2), {Position = UDim2.new(0, 2, 0.5, -7), BackgroundColor3 = Color3.fromRGB(150,150,150)}):Play()
            end
            if callback then callback(state) end
        end
        if state then Update() end
        Togl.MouseButton1Click:Connect(function() state = not state; Update() end)
        return {SetValue = function(self, val) state = val; Update() end}
    end
    function TabObj:Slider(text, min, max, default, callback)
        local SldFrame = GUI:Create("Frame", {
            Parent = Page, Size = UDim2.new(1, -5, 0, 45), BackgroundColor3 = CurrentTheme.Element, BackgroundTransparency = 0
        })
        GUI:Create("UICorner", {CornerRadius = UDim.new(0, 6), Parent = SldFrame})
        GUI:Create("TextLabel", {
            Parent = SldFrame, Text = text, Size = UDim2.new(1, -20, 0, 20), Position = UDim2.new(0, 10, 0, 2),
            BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left, TextColor3 = CurrentTheme.Text, Font = Enum.Font.GothamMedium, TextSize = 13
        })
        
        local ValLabel = GUI:Create("TextLabel", {
            Parent = SldFrame, Text = string.format("%.1f", default or min), Size = UDim2.new(0, 50, 0, 20), Position = UDim2.new(1, -60, 0, 2),
            BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Right, TextColor3 = CurrentTheme.Text, Font = Enum.Font.Gotham, TextSize = 13
        })
        local Bar = GUI:Create("Frame", {
            Parent = SldFrame, Size = UDim2.new(1, -20, 0, 4), Position = UDim2.new(0, 10, 0, 30), BackgroundColor3 = Color3.fromRGB(30, 30, 30), BackgroundTransparency = 0
        })
        GUI:Create("UICorner", {CornerRadius = UDim.new(1,0), Parent = Bar})
        local Fill = GUI:Create("Frame", {Parent = Bar, Size = UDim2.new(0,0,1,0), BackgroundColor3 = CurrentTheme.Accent, BorderSizePixel = 0})
        GUI:Create("UICorner", {CornerRadius = UDim.new(1,0), Parent = Fill})
        local Knob = GUI:Create("Frame", {Parent = Fill, Size = UDim2.new(0,12,0,12), Position = UDim2.new(1,-6,0.5,-6), BackgroundColor3 = CurrentTheme.Accent})
        GUI:Create("UICorner", {CornerRadius = UDim.new(1,0), Parent = Knob})
        local dragging = false
        local function Update(input)
            local sizeX = math.clamp((input.Position.X - Bar.AbsolutePosition.X) / Bar.AbsoluteSize.X, 0, 1)
            local val = min + ((max - min) * sizeX)
            val = math.floor(val * 10) / 10
            Fill.Size = UDim2.new(sizeX, 0, 1, 0)
            ValLabel.Text = string.format("%.1f", val)
            if callback then callback(val) end
         end
        local pct = ((default or min) - min) / (max - min)
        Fill.Size = UDim2.new(pct, 0, 1, 0)
        Bar.InputBegan:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = true Update(i) end end)
        UserInputService.InputEnded:Connect(function(i) if i.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end end)
        UserInputService.InputChanged:Connect(function(i) if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then Update(i) end end)
    end
    function TabObj:Dropdown(text, options, default, callback)
        local DFrame = GUI:Create("Frame", {
            Parent = Page, Size = UDim2.new(1, -5, 0, 35), BackgroundColor3 = CurrentTheme.Element, ClipsDescendants = true, ZIndex = 2
        })
        GUI:Create("UICorner", {CornerRadius = UDim.new(0, 6), Parent = DFrame})
        local Header = GUI:Create("TextButton", {Parent = DFrame, Size = UDim2.new(1, 0, 0, 35), BackgroundTransparency = 1, Text = "", ZIndex = 3})
        
 local SelLbl = GUI:Create("TextLabel", {
            Parent = Header, Text = default, Size = UDim2.new(0.5, -30, 1, 0), Position = UDim2.new(0.5, 0, 0, 0),
            BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Right, TextColor3 = CurrentTheme.Text, Font = Enum.Font.Gotham, TextSize = 13, ZIndex = 3
        })
        GUI:Create("TextLabel", {
            Parent = Header, Text = text, Size = UDim2.new(0.5, 0, 1, 0), Position = UDim2.new(0, 10, 0, 0),
            BackgroundTransparency = 1, TextXAlignment = Enum.TextXAlignment.Left, TextColor3 = CurrentTheme.Text, Font = Enum.Font.GothamMedium, TextSize = 13, ZIndex = 3
        })
        local Arrow = GUI:Create("TextLabel", {
            Parent = Header, Text = "v", Size = UDim2.new(0, 20, 1, 0), Position = UDim2.new(1, -25, 0, 0),
            BackgroundTransparency = 1, TextColor3 = CurrentTheme.TextDim, Font = Enum.Font.GothamBold, TextSize = 12, ZIndex = 3
        })
        local Container = GUI:Create("Frame", {Parent = DFrame, Size = UDim2.new(1, 0, 0, 0), Position = UDim2.new(0,0,0,35), BackgroundTransparency = 1, ZIndex = 3})
        GUI:Create("UIListLayout", {Parent = Container, SortOrder = Enum.SortOrder.LayoutOrder})
        local isOpen = false
        local function BuildList(newOpts)
            for _, v in pairs(Container:GetChildren()) do if v:IsA("TextButton") then v:Destroy() end end
            local count = 0
            for _, opt in pairs(newOpts) do
                local Btn = GUI:Create("TextButton", {
                    Parent = Container, Size = UDim2.new(1, 0, 0, 25), BackgroundTransparency = 1, Text = tostring(opt), TextColor3 = CurrentTheme.TextDim, Font = Enum.Font.Gotham, TextSize = 12, ZIndex = 4
                })
                Btn.MouseButton1Click:Connect(function()
                    SelLbl.Text = tostring(opt)
                    isOpen = false
                    TweenService:Create(DFrame, TweenInfo.new(0.3), {Size = UDim2.new(1, -5, 0, 35)}):Play()
                    Arrow.Text = "v"
                    if callback then callback(opt) end
                end)
                count = count + 1
             end
            return count
        end
        local count = BuildList(options)
        Header.MouseButton1Click:Connect(function()
            isOpen = not isOpen
            if isOpen then
                TweenService:Create(DFrame, TweenInfo.new(0.3), {Size = UDim2.new(1, -5, 0, 35 + (count * 25))}):Play()
                Arrow.Text = "^"
            else
                TweenService:Create(DFrame, TweenInfo.new(0.3), {Size = UDim2.new(1, -5, 0, 35)}):Play()
                Arrow.Text = "v"
            end
        end)
        return {
            SetValues = function(self, vals) 
                options = vals; count = BuildList(vals)
                if isOpen then TweenService:Create(DFrame, TweenInfo.new(0.3), {Size = UDim2.new(1, -5, 0, 35 + (count * 25))}):Play() end
                if not vals or #vals == 0 then SelLbl.Text = "..." end
            end,
            SetValue = function(self, val) SelLbl.Text = tostring(val or "...") end
          }
    end
    return TabObj
end

-- ============================================================================
-- UI CONSTRUCTION
-- ============================================================================

local LastWindowPosition = UDim2.fromScale(0.5, 0.5)
local CurrentScreenGui = nil

local function DestroyInterface()
    if CurrentScreenGui then CurrentScreenGui:Destroy(); CurrentScreenGui = nil end
    GUI.Objects = {} 
end

local function LoadInterface()
    DestroyInterface()
    
    local Window = GUI:InitWindow("DOOMSENSE | Outcome Memories")
    CurrentScreenGui = Window.Gui 

    local MainFrame = Window.Gui:FindFirstChild("Main")
    if MainFrame then
        MainFrame.Position = LastWindowPosition
        MainFrame:GetPropertyChangedSignal("Position"):Connect(function() LastWindowPosition = MainFrame.Position end)
    end

    local TabMain = GUI:CreateTab(Window, "Main", "10709752906")
    local TabTeleport = GUI:CreateTab(Window, "Teleport", "10709782497")
    local TabAnim = GUI:CreateTab(Window, "Animations", "10723345518")
    local TabVisuals = GUI:CreateTab(Window, "Visuals", "6031265978")
    local TabSettings = GUI:CreateTab(Window, "Settings", "10734950309")

    -- [SETTINGS TAB]
    TabSettings:Section("Custom LMS")

    TabSettings:Toggle("Enable Custom LMS", LMS_State.Enabled, function(v)
        LMS_State.Enabled = v
        if not v then
            LMS_State.Active = false
            LMS_State.IsSequenceRunning = false
            ApplyLMS("Default")
        end
    end)

    -- SLIDER 1.2 - 5.0
    TabSettings:Slider("LMS Volume", 1.2, 5.0, LMS_State.Volume, function(v)
        LMS_State.Volume = v
        if LMS_State.Enabled then ApplyLMS("Custom") end
    end)

    local lmsOptions = {}
    for name, _ in pairs(LMS_Library) do table.insert(lmsOptions, name) end
    table.sort(lmsOptions)

    TabSettings:Dropdown("Select Track", lmsOptions, LMS_State.SelectedTrack, function(val)
        LMS_State.SelectedTrack = val
        if LMS_State.Enabled then ApplyLMS("Custom") end
    end)

    -- [SETTINGS TAB]
    TabSettings:Section("Theme Customization")
    local CurrentThemeList = {}
    for name, _ in pairs(CurrentThemes) do table.insert(CurrentThemeList, name) end

    TabSettings:Dropdown("Select Theme", CurrentThemeList, SelectedThemeName, function(val)
        SelectedThemeName = val
    end)

    TabSettings:Button("Reload Menu (Apply Theme)", function()
        CurrentTheme = CurrentThemes[SelectedThemeName]
        _G.DoomsenseTheme = CurrentTheme
        LoadInterface()
    end)
    
    TabSettings:Button("REJOIN SERVER", function()
        if #Players:GetPlayers() <= 1 then
            TeleportService:Teleport(game.PlaceId, LocalPlayer)
        else
            TeleportService:TeleportToPlaceInstance(game.PlaceId, game.JobId, LocalPlayer)
        end
    end)

    -- [MAIN TAB]
    TabMain:Section("Movement")
    T_Fly = TabMain:Toggle("Flight (G)", State.IsFlying, function(v)
        State.IsFlying = v
        AppConfig.Fly = v
        if v then EnableFly() else CleanPhysics() end
    end)

    T_Speed = TabMain:Toggle("SpeedHack (C)", State.IsSpeeding, function(v) State.IsSpeeding = v end)
    TabMain:Toggle("Noclip", AppConfig.Noclip, function(v) AppConfig.Noclip = v end)
    TabMain:Slider("Fly Speed", 20, 200, AppConfig.FlySpeed, function(v) AppConfig.FlySpeed = v end)
    TabMain:Slider("Walk Speed", 16, 150, AppConfig.WalkSpeed, function(v) AppConfig.WalkSpeed = v end)

    TabMain:Section("Automation")
    T_Ring = TabMain:Toggle("Auto Ring Teleport (T)", AppConfig.AutoRing, function(v) 
        AppConfig.AutoRing = v 
        if v then
            game:GetService("StarterGui"):SetCore("SendNotification", {Title = "DOOMSENSE", Text = "ART ON (Wait for 80s State)", Duration = 2})
        else
            game:GetService("StarterGui"):SetCore("SendNotification", {Title = "DOOMSENSE", Text = "ART OFF", Duration = 2})
        end
    end)
    
    TabMain:Toggle("No Cooldown Jump", AppConfig.NoCDJump, function(v) 
        AppConfig.NoCDJump = v
        
        if Connections["JumpCDLoop"] then 
            Connections["JumpCDLoop"]:Disconnect() 
            Connections["JumpCDLoop"] = nil 
        end

        if v then
            Connections["JumpCDLoop"] = game:GetService("RunService").Heartbeat:Connect(function()
                if not AppConfig.NoCDJump then return end
                
                local char = LocalPlayer.Character
                local hum = char and char:FindFirstChildOfClass("Humanoid")
                
                if hum and char:FindFirstChild("HumanoidRootPart") then
                    -- 1. Jump Properties
                    hum.UseJumpPower = true
                    hum.JumpPower = 50 
                    hum.JumpHeight = 7.2 
                    
                    -- 2. Unlock States
                    hum:SetStateEnabled(Enum.HumanoidStateType.Jumping, true)
                    
                    -- 3. Bhop
                    local state = hum:GetState()
                    if state == Enum.HumanoidStateType.Landed or state == Enum.HumanoidStateType.FallingDown then
                        hum:ChangeState(Enum.HumanoidStateType.Running)
                    end

                    -- 4. Attribute Reset
                    if char:GetAttribute("JumpCD") then 
                        char:SetAttribute("JumpCD", false) 
                    end
                    if char:GetAttribute("CanJump") == false then 
                        char:SetAttribute("CanJump", true) 
                    end
                end
            end)
        end
    end)

    -- [TELEPORT TAB]
    TabTeleport:Section("Players")
    local function GetPlayerList()
        local list = {}
        for _, v in pairs(Players:GetPlayers()) do
            if v ~= LocalPlayer then
                local charName = "None"
                if v.Character then charName = v.Character:GetAttribute("Character") or v.Character.Name end
                table.insert(list, v.Name .. " | " .. charName) 
            end
        end
        return list
    end
    local PlayerDropdown = TabTeleport:Dropdown("Select Player", GetPlayerList(), nil, function(val)
        if val then
            local username = string.split(val, " | ")[1]
            State.SelectedPlayer = username
        end
    end)
    TabTeleport:Button("Refresh Players", function()
        PlayerDropdown:SetValues(GetPlayerList())
        PlayerDropdown:SetValue(nil)
    end)
    TabTeleport:Button("Teleport", function()
        if State.SelectedPlayer then
            local p = Players:FindFirstChild(State.SelectedPlayer)
            if p and p.Character and p.Character:FindFirstChild("HumanoidRootPart") and LocalPlayer.Character then
                LocalPlayer.Character.HumanoidRootPart.CFrame = p.Character.HumanoidRootPart.CFrame + Vector3.new(0,3,0)
            end
        end
    end)

    -- [ANIMATIONS TAB]
    local SelectedAnimChar = "2011X"
    local SelectedAnimName = ""
    local AnimListDropdown
    TabAnim:Section("Configuration")
    TabAnim:Dropdown("Character Assets", OrderedCharacters, "2011X", function(v)
        SelectedAnimChar = v
        local dbKey = NameToKey[v] or v
        local anims = AnimDB[dbKey]
        local names = {}
        if anims then for _, a in pairs(anims) do table.insert(names, a.Name) end end
        AnimListDropdown:SetValues(names)
    end)
    AnimListDropdown = TabAnim:Dropdown("Select Animation", {}, "...", function(v) SelectedAnimName = v end)

    local function ToggleAnim()
        if AnimTrack and AnimTrack.IsPlaying then
            AnimTrack:Stop()
            return
        end
        
        local dbKey = NameToKey[SelectedAnimChar] or SelectedAnimChar
        if AnimDB[dbKey] and SelectedAnimName ~= "" then
            for _, anim in pairs(AnimDB[dbKey]) do
                if anim.Name == SelectedAnimName then
                    local char = LocalPlayer.Character
                    local hum = char and char:FindFirstChild("Humanoid")
                    if hum then
                        local animator = hum:FindFirstChild("Animator") or Instance.new("Animator", hum)
                        if AnimTrack then AnimTrack:Stop() end
                        
                        local a = Instance.new("Animation")
                        a.AnimationId = "rbxassetid://" .. anim.Id
                        AnimTrack = animator:LoadAnimation(a)
                        AnimTrack.Priority = Enum.AnimationPriority.Action4
                        AnimTrack:Play()
                    end
                    break
                end
            end
        end
    end

    TabAnim:Button("Play Animation (R)", function()
        ToggleAnim()
    end)

    UserInputService.InputBegan:Connect(function(input, gpe)
        if gpe then return end
        if input.KeyCode == Enum.KeyCode.R then ToggleAnim() end
        if input.KeyCode == Enum.KeyCode.Insert then Main.Visible = not Main.Visible end
    end)

    -- [VISUALS TAB]
    TabVisuals:Section("ESP")
    TabVisuals:Toggle("Player ESP", AppConfig.ESP, function(v) AppConfig.ESP = v end)
    TabVisuals:Toggle("EXE Glow", AppConfig.Glow, function(v) AppConfig.Glow = v end)
    TabVisuals:Toggle("Pad ESP (Yellow)", AppConfig.PadESP, function(v) AppConfig.PadESP = v end)
    TabVisuals:Section("Effects")
    TabVisuals:Button("Remove Water Effects", function()
        local cam = Workspace.CurrentCamera
        if cam:FindFirstChild("WaterBlur") then cam.WaterBlur:Destroy() end
        if cam:FindFirstChild("WaterCorrection") then cam.WaterCorrection:Destroy() end
        game:GetService("StarterGui"):SetCore("SendNotification", {Title="DOOMSENSE", Text="Water Effects Deleted", Duration=2})
    end)
    TabVisuals:Toggle("Fullbright", false, function(v)
        Lighting.Ambient = v and Color3.new(1,1,1) or Color3.new(0,0,0)
    end)

    -- MOBILE BUTTONS INITIALIZATION
    MobileControl:RefreshVisibility()

    -- 1. MENU BUTTON
    MobileControl:CreateButton("Menu", MOB_ICONS.Menu, UDim2.new(1, -70, 0.2, 0), function(isActive)
        local MainFrame = CurrentScreenGui and CurrentScreenGui:FindFirstChild("Main")
        if MainFrame then
            -- Прямая установка: Если кнопка горит (isActive), меню должно быть видно
            MainFrame.Visible = isActive 
        end
    end)

    -- 2. FLY BUTTON
    MobileControl:CreateButton("Fly", MOB_ICONS.Fly, UDim2.new(1, -70, 0.2, 60), function(isActive)
        State.IsFlying = isActive
        AppConfig.Fly = isActive
        if T_Fly then T_Fly:SetValue(isActive) end -- Sync with GUI toggle
        if isActive then EnableFly() else CleanPhysics() end
    end)

    -- 3. SPEED BUTTON
    MobileControl:CreateButton("Speed", MOB_ICONS.Speed, UDim2.new(1, -70, 0.2, 120), function(isActive)
        State.IsSpeeding = isActive
        if T_Speed then T_Speed:SetValue(isActive) end
    end)

    -- 4. ART BUTTON
    MobileControl:CreateButton("ART", MOB_ICONS.ART, UDim2.new(1, -70, 0.2, 180), function(isActive)
        AppConfig.AutoRing = isActive
        if T_Ring then T_Ring:SetValue(isActive) end
        if isActive then
        end
    end)

    -- 5. TAUNT BUTTON
    MobileControl:CreateButton("Taunt", MOB_ICONS.Taunt, UDim2.new(1, -70, 0.2, 240), function(isActive)
        ToggleAnim()
        task.delay(0.2, function()
            local btn = MobileControl.Buttons["Taunt"]
            if btn then 
                btn.State = false 
                btn.Update() 
            end
        end)
    end)
    
    MobileControl:UpdateAllThemes()
end

-- ============================================================================
-- RUNTIME LOOPS
-- ============================================================================

table.insert(Connections, UserInputService.InputBegan:Connect(function(input, gpe)
    if gpe then return end
    if input.KeyCode == Enum.KeyCode.G then if T_Fly then T_Fly:SetValue(not State.IsFlying) end end
    if input.KeyCode == Enum.KeyCode.C then if T_Speed then T_Speed:SetValue(not State.IsSpeeding) end end
    if input.KeyCode == Enum.KeyCode.T then if T_Ring then T_Ring:SetValue(not AppConfig.AutoRing) end end
end))

RunService.Stepped:Connect(function()
    if not LocalPlayer.Character then return end
    local root = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    local hum = LocalPlayer.Character:FindFirstChild("Humanoid")
    if not root or not hum then return end

    if AppConfig.Noclip then
        for _, p in pairs(LocalPlayer.Character:GetDescendants()) do
            if p:IsA("BasePart") then p.CanCollide = false end
        end
    end

    if State.IsFlying and BodyVel then
        local cam = Camera.CFrame
        local move = Vector3.new(0,0,0)
        if UserInputService:IsKeyDown(Enum.KeyCode.W) then move = move + cam.LookVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.S) then move = move - cam.LookVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.A) then move = move - cam.RightVector end
        if UserInputService:IsKeyDown(Enum.KeyCode.D) then move = move + cam.RightVector end
        
        if move.Magnitude > 0 then BodyVel.Velocity = move.Unit * AppConfig.FlySpeed
        else BodyVel.Velocity = Vector3.new(0, 0.1, 0) end
        BodyGyro.CFrame = CFrame.new(root.Position, root.Position + cam.LookVector)
    elseif State.IsSpeeding and not State.IsFlying then
        if hum.MoveDirection.Magnitude > 0 then
            root.Velocity = Vector3.new(hum.MoveDirection.X * AppConfig.WalkSpeed, root.Velocity.Y, hum.MoveDirection.Z * AppConfig.WalkSpeed)
        end
    end
end)

RunService:BindToRenderStep("DoomFlyLoop", Enum.RenderPriority.Camera.Value + 1, function()
    if not AppConfig.Fly or not LocalPlayer.Character then return end
    local root = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    if root and not root:FindFirstChild("DoomVel") then EnableFly() return end
end)

local VisualsFolder = Instance.new("Folder", CoreGui)
VisualsFolder.Name = "DoomsenseVisuals"

local RAGE_MUSIC_IDS = {
    "12803522657",
    "9057530869",
    "72233377540950" 
}

-- VISUALS LOOP
task.spawn(function()
    while true do
        if not IsScriptActive then break end
        task.wait(0.5)
        VisualsFolder:ClearAllChildren()
        
        -- 1. Game State
        local currentState = "UNKNOWN"
        if Workspace:FindFirstChild("GameProperties") and Workspace.GameProperties:FindFirstChild("State") then
            currentState = Workspace.GameProperties.State.Value
        end
        local isRoundActive = (currentState == "ING" or currentState == "80s")

        if isRoundActive then
            local myChar = LocalPlayer.Character
            local isRageMusic = false
            
            -- Rage Mode
            if myChar and myChar.Name == "2011x" then
                for _, s in pairs(SoundService:GetDescendants()) do
                    if s:IsA("Sound") and s.Playing then
                        for _, id in pairs(RAGE_MUSIC_IDS) do
                            if string.find(tostring(s.SoundId), id) then
                                isRageMusic = true
                                break
                            end
                        end
                    end
                    if isRageMusic then break end
                end
                
                if isRageMusic then
                    for _, part in pairs(myChar:GetChildren()) do
                        if part:IsA("BasePart") then
                            part.Material = Enum.Material.Neon
                            part.Color = Color3.fromRGB(255, 0, 0)
                        elseif part:IsA("Accessory") and part:FindFirstChild("Handle") then
                             part.Handle.Color = Color3.fromRGB(255, 0, 0)
                             part.Handle.Material = Enum.Material.Neon
                        end
                    end
                    if myChar:FindFirstChild("Head") and myChar.Head:FindFirstChild("face") then
                        myChar.Head.face.Texture = "rbxassetid://6341235966"
                    end
                end
            end

            -- ESP 
            if AppConfig.ESP or AppConfig.Glow then
                for _, p in pairs(Players:GetPlayers()) do
                    if p ~= LocalPlayer then
                        local pModel = p.Character or (Workspace:FindFirstChild("Players") and Workspace.Players:FindFirstChild(p.Name))
                        
                        if pModel and pModel:FindFirstChild("HumanoidRootPart") then
                            local isExe = IsEXE(pModel)
                            
                            -- Highlight ESP
                            if AppConfig.ESP then
                                local color = isExe and Color3.fromRGB(255, 0, 0) or Color3.fromRGB(0, 255, 0)
                                local hl = Instance.new("Highlight", VisualsFolder)
                                hl.Adornee = pModel
                                hl.FillColor = color
                                hl.OutlineColor = Color3.new(1,1,1)
                                hl.FillTransparency = 0.5
                            end

                            -- Text EXE
                            if isExe and AppConfig.ESP then
                                local targetPart = pModel:FindFirstChild("Head") 
                                    or pModel:FindFirstChild("face") 
                                    or pModel:FindFirstChild("Torso") 
                                    or pModel:FindFirstChild("UpperTorso") 
                                    or pModel.HumanoidRootPart

                                if targetPart then
                                    local bg = Instance.new("BillboardGui", VisualsFolder)
                                    bg.Adornee = targetPart
                                    bg.Size = UDim2.new(0, 100, 0, 50)
                                    bg.StudsOffset = Vector3.new(0, 4, 0)
                                    bg.AlwaysOnTop = true
                                    
                                    local txtExe = Instance.new("TextLabel", bg)
                                    txtExe.Size = UDim2.new(1, 0, 0.5, 0)
                                    txtExe.Position = UDim2.new(0, 0, 0.4, 0)
                                    txtExe.BackgroundTransparency = 1
                                    txtExe.Text = "EXE"
                                    txtExe.TextColor3 = Color3.fromRGB(255, 0, 0)
                                    txtExe.TextStrokeColor3 = Color3.new(0, 0, 0)
                                    txtExe.TextStrokeTransparency = 0
                                    txtExe.Font = Enum.Font.Arcade
                                    txtExe.TextSize = 25

                                    -- Rage Label Logic
                                    local isRage = false
                                    if pModel.HumanoidRootPart:FindFirstChild("RageFill") then 
                                        isRage = true
                                    elseif Workspace:FindFirstChild("Assets") and Workspace.Assets:FindFirstChild("Songs") and Workspace.Assets.Songs:FindFirstChild("Rage") then 
                                        isRage = true 
                                    end

                                    local charName = pModel:GetAttribute("Character") or pModel.Name
                                    if string.find(string.lower(charName), "2011x") and isRage then
                                        local txtRage = Instance.new("TextLabel", bg)
                                        txtRage.Size = UDim2.new(1, 0, 0.5, 0)
                                        txtRage.Position = UDim2.new(0, 0, 0, 0)
                                        txtRage.BackgroundTransparency = 1
                                        txtRage.Text = "RAGE"
                                        txtRage.TextColor3 = Color3.fromRGB(255, 170, 0)
                                        txtRage.TextStrokeColor3 = Color3.new(0,0,0)
                                        txtRage.TextStrokeTransparency = 0
                                        txtRage.Font = Enum.Font.Arcade
                                        txtRage.TextSize = 20
                                    end
                                end
                            end
                            
                            -- Glow Logic
                            if AppConfig.Glow and isExe then
                                local hl = Instance.new("Highlight", VisualsFolder)
                                hl.Adornee = pModel
                                hl.FillTransparency = 1
                                hl.OutlineColor = Color3.new(1,0,0)
                            end
                        end
                    end
                end
            end

            -- Pad ESP
            if AppConfig.PadESP and Workspace:FindFirstChild("Maps") then
                for _, obj in pairs(Workspace.Maps:GetDescendants()) do
                    if obj.Name == "Pad" and obj:IsA("BasePart") then
                        local hl = Instance.new("Highlight", VisualsFolder)
                        hl.Adornee = obj
                        hl.FillColor = Color3.new(1,1,0)
                        hl.OutlineColor = Color3.new(1,1,0)
                    end
                end
            end
            
            if AppConfig.AutoRing and currentState == "80s" and LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
                for _, v in pairs(Workspace:GetDescendants()) do
                    if v:IsA("MeshPart") and v.MeshId == "rbxassetid://106058960373684" then
                        LocalPlayer.Character.HumanoidRootPart.CFrame = v.CFrame + Vector3.new(0,3,0)
                        break
                    end
                end
            end
        end
    end
end)

LoadInterface()
print("██████╗░░█████╗░░█████╗░███╗░░░███╗░██████╗███████╗███╗░░██╗░██████╗███████╗ ██╗░░░██╗██████╗░")
print("██╔══██╗██╔══██╗██╔══██╗████╗░████║██╔════╝██╔════╝████╗░██║██╔════╝██╔════╝ ██║░░░██║╚════██╗")
print("██║░░██║██║░░██║██║░░██║██╔████╔██║╚█████╗░█████╗░░██╔██╗██║╚█████╗░█████╗░░ ╚██╗░██╔╝░░███╔═╝")
print("██║░░██║██║░░██║██║░░██║██║╚██╔╝██║░╚═══██╗██╔══╝░░██║╚████║░╚═══██╗██╔══╝░░ ░╚████╔╝░██╔══╝░░")
print("██████╔╝╚█████╔╝╚█████╔╝██║░╚═╝░██║██████╔╝███████╗██║░╚███║██████╔╝███████╗ ░░╚██╔╝░░███████╗")
print("╚═════╝░░╚════╝░░╚════╝░╚═╝░░░░░╚═╝╚═════╝░╚══════╝╚═╝░░╚══╝╚═════╝░╚══════╝ ░░░╚═╝░░░╚══════╝")